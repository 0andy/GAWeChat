{"version":3,"file":"acl.service.js","sourceRoot":"","sources":["../../../.ng_build/acl/services/acl.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable } from '@angular/core';\r\nimport { ACLType, ACLCanType } from './acl.type';\r\n\r\n/**\r\n * 访问控制服务\r\n */\r\n@Injectable()\r\nexport class ACLService {\r\n\r\n    private roles: string[] = [];\r\n    private abilities: (number | string)[] = [];\r\n    private full = false;\r\n\r\n    /** 获取所有数据 */\r\n    get data() {\r\n        return {\r\n            full: this.full,\r\n            roles: this.roles,\r\n            abilities: this.abilities\r\n        };\r\n    }\r\n\r\n    private parseACLType(val: string | string[] | ACLType): ACLType {\r\n        if (typeof val !== 'string' && !Array.isArray(val)) {\r\n            return <ACLType>val;\r\n        }\r\n        if (Array.isArray(val)) {\r\n            return <ACLType>{ role: <string[]>val };\r\n        }\r\n        return <ACLType>{\r\n            role: [val]\r\n        };\r\n    }\r\n\r\n    /**\r\n     * 设置当前用户角色或权限能力（会先清除所有）\r\n     *\r\n     * @param {ACLType} value\r\n     */\r\n    set(value: ACLType) {\r\n        this.abilities = [];\r\n        this.roles = [];\r\n        this.add(value);\r\n    }\r\n\r\n    /**\r\n     * 标识当前用户为全量，即不受限\r\n     *\r\n     * @param {boolean} val\r\n     */\r\n    setFull(val: boolean) {\r\n        this.full = val;\r\n    }\r\n\r\n    /**\r\n     * 设置当前用户权限能力（会先清除所有）\r\n     *\r\n     * @param {((number | string)[])} abilities\r\n     */\r\n    setAbility(abilities: (number | string)[]) {\r\n        this.set(<ACLType>{ ability: abilities });\r\n    }\r\n\r\n    /**\r\n     * 设置当前用户角色（会先清除所有）\r\n     *\r\n     * @param {string[]} roles\r\n     */\r\n    setRole(roles: string[]) {\r\n        this.set(<ACLType>{ role: roles });\r\n    }\r\n\r\n    /**\r\n     * 为当前用户增加角色或权限能力\r\n     *\r\n     * @param {ACLType} value\r\n     */\r\n    add(value: ACLType) {\r\n        if (value.role && value.role.length > 0) {\r\n            this.roles.push(...value.role);\r\n        }\r\n        if (value.ability && value.ability.length > 0) {\r\n            this.abilities.push(...value.ability);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 为当前用户附加角色\r\n     *\r\n     * @param {string[]} roles\r\n     */\r\n    attachRole(roles: string[]) {\r\n        for (const val of roles) {\r\n            if (!this.roles.includes(val)) {\r\n                this.roles.push(val);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 为当前用户附加权限\r\n     *\r\n     * @param {((number | string)[])} abilities\r\n     */\r\n    attachAbility(abilities: (number | string)[]) {\r\n        for (const val of abilities) {\r\n            if (!this.abilities.includes(val)) {\r\n                this.abilities.push(val);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 为当前用户移除角色\r\n     *\r\n     * @param {string[]} roles\r\n     */\r\n    removeRole(roles: string[]) {\r\n        for (const val of roles) {\r\n            const idx = this.roles.indexOf(val);\r\n            if (idx !== -1) {\r\n                this.roles.splice(idx, 1);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 为当前用户移除权限\r\n     *\r\n     * @param {((number | string)[])} abilities\r\n     */\r\n    removeAbility(abilities: (number | string)[]) {\r\n        for (const val of abilities) {\r\n            const idx = this.abilities.indexOf(val);\r\n            if (idx !== -1) {\r\n                this.abilities.splice(idx, 1);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 当前用户是否有对应角色，其实 `number` 表示Ability\r\n     *\r\n     * @param {ACLCanType} roleOrAbility\r\n     */\r\n    can(roleOrAbility: ACLCanType): boolean {\r\n        if (this.full === true || !roleOrAbility) {\r\n            return true;\r\n        }\r\n\r\n        let t: ACLType = {};\r\n        if (typeof roleOrAbility === 'number') {\r\n            t = { ability: [ roleOrAbility ] };\r\n        } else if (Array.isArray(roleOrAbility) && roleOrAbility.length > 0 && typeof roleOrAbility[0] === 'number') {\r\n            t = { ability: roleOrAbility };\r\n        } else {\r\n            t = this.parseACLType(roleOrAbility);\r\n        }\r\n\r\n        if (t.role) {\r\n            for (const _r of t.role) {\r\n                if (this.roles.includes(_r)) {\r\n                    return true;\r\n                }\r\n            }\r\n        }\r\n        if (t.ability) {\r\n            for (const _p of t.ability) {\r\n                if (this.abilities.includes(_p)) {\r\n                    return true;\r\n                }\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * 当前用户是否有对应权限点\r\n     *\r\n     * @param {(number | string)} ability\r\n     */\r\n    canAbility(ability: number | string): boolean {\r\n        return this.can(<ACLType>{\r\n            ability: [ability],\r\n            role: null\r\n        });\r\n    }\r\n}\r\n"]}