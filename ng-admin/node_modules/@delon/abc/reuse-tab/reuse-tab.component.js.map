{"version":3,"file":"reuse-tab.component.js","sourceRoot":"","sources":["../../../.ng_build/abc/reuse-tab/reuse-tab.component.ts"],"names":[],"mappings":"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","sourcesContent":["import { Component, Input, Output, OnChanges, ChangeDetectionStrategy, ChangeDetectorRef, EventEmitter, OnInit, SimpleChanges, SimpleChange, OnDestroy, ElementRef, Renderer2, Inject } from '@angular/core';\r\nimport { Router, NavigationEnd, ActivatedRoute } from '@angular/router';\r\nimport { DOCUMENT } from '@angular/platform-browser';\r\nimport { Subscription } from 'rxjs/Subscription';\r\nimport { combineLatest } from 'rxjs/observable/combineLatest';\r\nimport { filter, debounceTime, take, first } from 'rxjs/operators';\r\nimport { coerceNumberProperty, coerceBooleanProperty } from '@angular/cdk/coercion';\r\nimport { ReuseTabService } from './reuse-tab.service';\r\nimport { ReuseTabCached, ReuseTabNotify } from './interface';\r\n\r\n@Component({\r\n    selector: 'reuse-tab',\r\n    templateUrl: './reuse-tab.component.html',\r\n    styleUrls: ['./reuse-tab.css'],\r\n    changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ReuseTabComponent implements OnInit, OnChanges, OnDestroy {\r\n    private sub$: Subscription;\r\n    _list: { url: string, title: string, [key: string]: any }[] = [];\r\n    _pos = 0;\r\n\r\n    /** 允许最多复用多少个页面 */\r\n    @Input()\r\n    get max() { return this._max; }\r\n    set max(value: any) {\r\n        this._max = coerceNumberProperty(value);\r\n    }\r\n    private _max: number;\r\n    /** 排除规则，限 `mode=URL` */\r\n    @Input() excludes: RegExp[];\r\n    /** 允许关闭 */\r\n    @Input()\r\n    get allowClose() { return this._allowClose; }\r\n    set allowClose(value: any) {\r\n        this._allowClose = coerceBooleanProperty(value);\r\n    }\r\n    private _allowClose = true;\r\n    /** 总是显示当前页 */\r\n    @Input()\r\n    get showCurrent() { return this._showCurrent; }\r\n    set showCurrent(value: any) {\r\n        this._showCurrent = coerceBooleanProperty(value);\r\n    }\r\n    private _showCurrent = true;\r\n    /** 是否固定 */\r\n    @Input()\r\n    get fixed() { return this._fixed; }\r\n    set fixed(value: any) {\r\n        this._fixed = coerceBooleanProperty(value);\r\n    }\r\n    private _fixed = true;\r\n    /** 切换时回调 */\r\n    @Output() change: EventEmitter<any> = new EventEmitter<any>();\r\n    /** 关闭回调 */\r\n    @Output() close: EventEmitter<any> = new EventEmitter<any>();\r\n\r\n    constructor(\r\n        public srv: ReuseTabService,\r\n        private cd: ChangeDetectorRef,\r\n        private router: Router,\r\n        private route: ActivatedRoute,\r\n        private el: ElementRef,\r\n        private render: Renderer2,\r\n        @Inject(DOCUMENT) private doc: any\r\n    ) { }\r\n\r\n    private gen(url?: string) {\r\n        if (!url) url = this.srv.getUrl(this.route.snapshot);\r\n        const ls = [...this.srv.items].map((item: ReuseTabCached, index: number) => {\r\n            return {\r\n                url: item.url,\r\n                // closabled: this.allowClose && item.closable,\r\n                title: item.customTitle || item.title,\r\n                index\r\n            };\r\n        });\r\n        if (this.showCurrent) {\r\n            const idx = ls.findIndex(w => w.url === url);\r\n            if (idx !== -1) {\r\n                this._pos = idx;\r\n            } else {\r\n                ls.push({\r\n                    url,\r\n                    title: this.srv.getTitle(url, this.srv.getTruthRoute(this.route.snapshot)),\r\n                    // closabled: this.allowClose && this.srv.getClosable(url, next.snapshot),\r\n                    index: -1\r\n                });\r\n                this._pos = ls.length;\r\n            }\r\n        } else {\r\n            this._pos = ls.length;\r\n        }\r\n        this._list = ls;\r\n        this.visibility();\r\n        this.cd.markForCheck();\r\n    }\r\n\r\n    private visibility() {\r\n        if (this.showCurrent) return ;\r\n        this.render.setStyle(this.el.nativeElement, 'display', this._list.length === 0 ? 'none' : 'block');\r\n    }\r\n\r\n    to(index: number) {\r\n        const item = this._list[index];\r\n        if (!item || !item.url) return ;\r\n        this.router.navigateByUrl(item.url);\r\n        this.change.emit(item);\r\n    }\r\n\r\n    private removeByUrl(url: string): string {\r\n        const removeIdx = this._list.findIndex(w => w.url === url);\r\n        if (removeIdx === -1) return null;\r\n\r\n        this.remove(removeIdx);\r\n        return this._list[Math.min(removeIdx, this._list.length - 1)].url;\r\n    }\r\n\r\n    remove(idx: number) {\r\n        if (this.showCurrent && this._list.length === 1) return false;\r\n\r\n        const item = this._list[idx];\r\n        if (!this.srv._remove(item)) return false;\r\n\r\n        this._list.splice(idx, 1);\r\n\r\n        this.visibility();\r\n        this.cd.markForCheck();\r\n\r\n        this.close.emit(item);\r\n\r\n        if (this._pos === idx) {\r\n            this.to(this._pos);\r\n        }\r\n    }\r\n\r\n    clear() {\r\n        this._list = [ this._list.find(w => w.url === this.router.url) ];\r\n        this.srv.clear();\r\n        this.close.emit(null);\r\n    }\r\n\r\n    ngOnInit(): void {\r\n        this.setClass();\r\n\r\n        const route$ = this.router.events.pipe(\r\n            filter(evt => evt instanceof NavigationEnd)\r\n        );\r\n        this.sub$ = <any>combineLatest(this.srv.change, route$).pipe(\r\n            debounceTime(300)\r\n        ).subscribe(([res, url]) => {\r\n            let nextUrl = this.router.url;\r\n            if (res.active === 'remove' && res.url) {\r\n                nextUrl = this.removeByUrl(res.url);\r\n                if (nextUrl === null) return ;\r\n            }\r\n            this.gen(nextUrl);\r\n        });\r\n\r\n        const title$ = this.srv.change.pipe(\r\n            filter(w => w && w.active === 'title'),\r\n            first()\r\n        ).subscribe(res => {\r\n            this.gen(this.router.url);\r\n            title$.unsubscribe();\r\n        });\r\n\r\n        this.gen();\r\n    }\r\n\r\n    private setClass() {\r\n        const el = this.el.nativeElement;\r\n        const body = this.doc.querySelector('body');\r\n        const fixedCls = `fixed`;\r\n        const bodyCls = `has-reuse-tab`;\r\n        if (this.fixed) {\r\n            this.render.addClass(el, fixedCls);\r\n            this.render.addClass(body, bodyCls);\r\n        } else {\r\n            this.render.removeClass(el, fixedCls);\r\n            this.render.removeClass(body, bodyCls);\r\n        }\r\n    }\r\n\r\n    ngOnChanges(changes: { [P in keyof this]?: SimpleChange } & SimpleChanges): void {\r\n        if (changes.max) this.srv.max = this.max;\r\n        if (changes.excludes) this.srv.excludes = this.excludes;\r\n        this.setClass();\r\n        this.cd.markForCheck();\r\n    }\r\n\r\n    ngOnDestroy(): void {\r\n        if (this.sub$) this.sub$.unsubscribe();\r\n    }\r\n}\r\n"]}