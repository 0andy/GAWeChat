{"version":3,"file":"menu.service.js","sourceRoot":"","sources":["../../../../.ng_build/theme/services/menu/menu.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable, Inject, Optional, OnDestroy } from '@angular/core';\r\nimport { Observable } from 'rxjs/Observable';\r\nimport { BehaviorSubject } from 'rxjs/BehaviorSubject';\r\nimport { share } from 'rxjs/operators';\r\nimport { ALAIN_I18N_TOKEN, AlainI18NService } from '../i18n/i18n';\r\nimport { ACLService } from '@delon/acl';\r\n\r\nexport interface Menu {\r\n    /** 文本 */\r\n    text: string;\r\n    /** i18n主键 */\r\n    i18n?: string;\r\n    /** 是否菜单组 */\r\n    group?: boolean;\r\n    /** angular 路由 */\r\n    link?: string;\r\n    /** 外部链接 */\r\n    externalLink?: string;\r\n    /** 链接 target */\r\n    target?: '_blank' | '_self' | '_parent' | '_top';\r\n    /** 图标 */\r\n    icon?: string;\r\n    /** 徽标数，展示的数字。（注：`group:true` 无效） */\r\n    badge?: number;\r\n    /** 徽标数，显示小红点 */\r\n    badge_dot?: boolean;\r\n    /** 徽标数，设置 Badge 颜色 （默认：error， 所有颜色值见：https://github.com/cipchk/ng-alain/blob/master/_documents/utils.md#色彩） */\r\n    badge_status?: string;\r\n    /** 是否隐藏 */\r\n    hide?: boolean;\r\n    /** ACL配置，若导入 `@delon/acl` 时自动有效 */\r\n    acl?: any;\r\n    /** 是否快捷菜单项 */\r\n    shortcut?: boolean;\r\n    /** 快捷菜单根节点 */\r\n    shortcut_root?: boolean;\r\n    /** 是否允许复用，需配合 `reuse-tab` 组件 */\r\n    reuse?: boolean;\r\n    /** 二级菜单 */\r\n    children?: Menu[];\r\n    /**\r\n     * 菜单类型，无须指定由 Service 自动识别\r\n     * 1：链接\r\n     * 2：外部链接\r\n     * 3：链接（子菜单）\r\n     * @private\r\n     */\r\n    _type?: number;\r\n    /**\r\n     * 是否选中\r\n     * @private\r\n     */\r\n    _selected?: boolean;\r\n    /**\r\n     * 是否隐藏菜单\r\n     * @private\r\n     */\r\n    _hidden?: boolean;\r\n    /**\r\n     * 是否打开\r\n     * @private\r\n     */\r\n    _open?: boolean;\r\n    /**\r\n     * @private\r\n     */\r\n    _depth?: number;\r\n\r\n    [key: string]: any;\r\n}\r\n\r\n@Injectable()\r\nexport class MenuService implements OnDestroy {\r\n\r\n    private _change$: BehaviorSubject<Menu[]> = new BehaviorSubject<Menu[]>([]);\r\n\r\n    private data: Menu[] = [];\r\n\r\n    constructor(\r\n        @Optional() @Inject(ALAIN_I18N_TOKEN) private i18nService: AlainI18NService,\r\n        @Optional() private aclService: ACLService\r\n    ) { }\r\n\r\n    get change(): Observable<Menu[]> {\r\n        return this._change$.pipe(share());\r\n    }\r\n\r\n    visit(callback: (item: Menu, parentMenum: Menu, depth?: number) => void) {\r\n        const inFn = (list: Menu[], parentMenu: Menu, depth: number) => {\r\n            for (const item of list) {\r\n                callback(item, parentMenu, depth);\r\n                if (item.children && item.children.length > 0) {\r\n                    inFn(item.children, item, depth + 1);\r\n                } else {\r\n                    item.children = [];\r\n                }\r\n            }\r\n        };\r\n\r\n        inFn(this.data, null, 0);\r\n    }\r\n\r\n    add(items: Menu[]) {\r\n        this.data.push(...items);\r\n        this.resume();\r\n    }\r\n\r\n    /**\r\n     * 重置菜单，可能I18N、用户权限变动时需要调用刷新\r\n     */\r\n    resume(callback?: (item: Menu, parentMenum: Menu, depth?: number) => void) {\r\n        let i = 1;\r\n        this.removeShortcut();\r\n        const shortcuts: Menu[] = [];\r\n        this.visit((item, parent, depth) => {\r\n            item.__id = i++;\r\n            item.__parent = parent;\r\n            item._depth = depth;\r\n\r\n            if (!item.link) item.link = '';\r\n            if (!item.externalLink) item.externalLink = '';\r\n\r\n            // badge\r\n            if (item.badge) {\r\n                if (item.badge_dot !== true) {\r\n                    item.badge_dot = false;\r\n                }\r\n                if (!item.badge_status) {\r\n                    item.badge_status = 'error';\r\n                }\r\n            }\r\n\r\n            item._type = item.externalLink ? 2 : 1;\r\n            if (item.children && item.children.length > 0) {\r\n                item._type = 3;\r\n            }\r\n\r\n            // shortcut\r\n            if (item.shortcut === true && (item.link || item.externalLink))\r\n                shortcuts.push(item);\r\n\r\n            const i18n = item.i18n || item.translate;\r\n            item.text = this.i18nService && i18n ? this.i18nService.fanyi(i18n) : item.text;\r\n\r\n            // hidden\r\n            item._hidden = typeof item.hide === 'undefined' ? false : item.hide;\r\n\r\n            // acl\r\n            if (item.acl && this.aclService) {\r\n                item._hidden = !this.aclService.can(item.acl);\r\n            }\r\n\r\n            if (callback) callback(item, parent, depth);\r\n        });\r\n\r\n        this.loadShortcut(shortcuts);\r\n        this._change$.next(this.data);\r\n    }\r\n\r\n    /**\r\n     * 加载快捷菜单，加载位置规则如下：\r\n     * 1、统一在下标0的节点下（即【主导航】节点下方）\r\n     *      1、若 children 存在 【shortcut_root: true】则最优先【推荐】这种方式\r\n     *      2、否则查找带有【dashboard】字样链接，若存在则在此菜单的下方创建快捷入口\r\n     *      3、否则放在0节点位置\r\n     */\r\n    private loadShortcut(shortcuts: Menu[]) {\r\n        if (shortcuts.length === 0 || this.data.length === 0) return;\r\n\r\n        const ls = this.data[0].children || [];\r\n        let pos = ls.findIndex(w => w.shortcut_root === true);\r\n        if (pos === -1) {\r\n            pos = ls.findIndex(w => w.link.includes('dashboard') || w.externalLink.includes('dashboard'));\r\n            pos = (pos !== -1 ? pos : -1) + 1;\r\n            this.data[0].children.splice(pos, 0, {\r\n                text: '快捷菜单',\r\n                translate: 'shortcut',\r\n                icon: 'icon-rocket',\r\n                children: []\r\n            });\r\n        }\r\n        let _data = this.data[0].children[pos];\r\n        _data = Object.assign(_data, {\r\n            shortcut_root: true,\r\n            _type: 3,\r\n            __id: -1,\r\n            _depth: 1\r\n        });\r\n        _data.children = shortcuts.map(i => {\r\n            i._depth = 2;\r\n            return i;\r\n        });\r\n    }\r\n\r\n    private removeShortcut() {\r\n        const ls = this.data && this.data.length && this.data[0].children || [];\r\n        const pos = ls.findIndex(w => w.shortcut_root === true);\r\n        if (pos !== -1) ls.splice(pos, 1);\r\n    }\r\n\r\n    get menus() {\r\n        return this.data;\r\n    }\r\n\r\n    /**\r\n     * 清空菜单\r\n     */\r\n    clear() {\r\n        this.data = [];\r\n        this._change$.next(this.data);\r\n    }\r\n\r\n    /**\r\n     * 根据URL设置菜单 `_open` 属性\r\n     * @param url URL地址\r\n     */\r\n    openedByUrl(url: string) {\r\n        if (!url) {\r\n            return;\r\n        }\r\n\r\n        let findItem: Menu = null;\r\n        this.visit(item => {\r\n            item._open = false;\r\n            if (!item.link) {\r\n                return;\r\n            }\r\n            if (!findItem && url.startsWith(item.link)) {\r\n                findItem = item;\r\n            }\r\n        });\r\n        if (!findItem) {\r\n            console.warn(`not found page name: ${url}`);\r\n            return;\r\n        }\r\n\r\n        do {\r\n            findItem._open = true;\r\n            findItem = findItem.__parent;\r\n        } while (findItem);\r\n    }\r\n\r\n    /**\r\n     * 根据url获取菜单列表\r\n     * @param url\r\n     */\r\n    getPathByUrl(url: string): Menu[] {\r\n        let item: Menu = null;\r\n        this.visit((i, parent, depth) => {\r\n            if (i.link === url) {\r\n                item = i;\r\n            }\r\n        });\r\n\r\n        const ret: Menu[] = [];\r\n        if (!item) return ret;\r\n\r\n        do {\r\n            ret.splice(0, 0, item);\r\n            item = item.__parent;\r\n        } while (item);\r\n\r\n        return ret;\r\n    }\r\n\r\n    ngOnDestroy(): void {\r\n        if (this._change$) this._change$.unsubscribe();\r\n    }\r\n}\r\n"]}